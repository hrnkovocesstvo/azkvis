<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>PÅ™enos dat mezi zaÅ™Ã­zenÃ­mi bez serveru</title>
    <link rel="stylesheet" href="style.css" />
    <script src="./Scripts/komunikace.js" defer></script>
    <script src="./Scripts/azKviz.js" defer></script>
    <script src="./Scripts/index.js" defer></script>
</head>

<body>
    <div id="webrtc-section">
        <h2>ðŸ“¡ WebRTC pÅ™enos dat (bez serveru)</h2>

        <p>
            <b>Krok 1:</b> Na <u>PC1</u> klikni â€žVytvoÅ™ spojenÃ­â€œ a zkopÃ­ruj Offer do
            <u>PC2</u>.
        </p>
        <p>
            <b>Krok 2:</b> Na <u>PC2</u> vloÅ¾ Offer, klikni â€žOdpovÄ›dÄ›tâ€œ a zkopÃ­ruj
            Answer zpÄ›t do <u>PC1</u>.
        </p>
        <hr />

        <textarea id="offer" placeholder="Offer / Answer JSON"></textarea><br />
        <button id="create">VytvoÅ™ spojenÃ­ (Offer)</button>
        <button id="answer">OdpovÄ›dÄ›t (Answer)</button>
        <button id="connect">PÅ™ipojit</button>

        <hr />

        <textarea id="log" readonly placeholder="Log..."></textarea><br />

        <input id="msg" placeholder="Zadej zprÃ¡vu..." />
        <button id="send">Odeslat</button>
    </div>

    <script>
        async function StartOtazky(source, options = {}) {
            options = options || {};
            const excludeIds = new Set(options.excludeIds || []);
            const excludePredicate =
                typeof options.excludePredicate === "function"
                    ? options.excludePredicate
                    : null;
            const noRepeatGlobal = !!options.noRepeatGlobal;

            // globÃ¡lnÃ­ tracking jiÅ¾ vybranÃ½ch otÃ¡zek napÅ™Ã­Ä volÃ¡nÃ­mi (pokud potÅ™ebujete)
            if (!window.__UsedOtazky) window.__UsedOtazky = new Set();

            let all = null;
            if (typeof source === "string") {
                try {
                    const resp = await fetch(source, { cache: "no-store" });
                    if (!resp.ok)
                        throw new Error("Chyba pÅ™i stahovÃ¡nÃ­: " + resp.status);
                    const json = await resp.json();
                    if (Array.isArray(json)) {
                        all = json.slice();
                    } else if (json && Array.isArray(json.otazky)) {
                        all = json.otazky.slice();
                    } else {
                        throw new Error("NaÄtenÃ½ JSON neobsahuje pole otÃ¡zek.");
                    }
                } catch (err) {
                    console.error(
                        "StartOtazky: nepodaÅ™ilo se naÄÃ­st otÃ¡zky ze souboru",
                        err
                    );
                    throw err;
                }
            } else if (Array.isArray(source)) {
                all = source.slice();
            } else if (Array.isArray(window.ALL_OTAZKY)) {
                all = window.ALL_OTAZKY.slice();
            } else {
                throw new Error(
                    "StartOtazky: nebyl pÅ™edÃ¡n zdroj otÃ¡zek (string | Array) a window.ALL_OTAZKY neexistuje."
                );
            }

            // filtrace podle excludeIds / predicate / globÃ¡lnÄ› pouÅ¾itÃ½ch
            const filtered = all.filter((q) => {
                if (!q) return false;
                if (q.id !== undefined && excludeIds.has(Number(q.id))) return false;
                if (excludePredicate && excludePredicate(q)) return false;
                if (
                    noRepeatGlobal &&
                    q.id !== undefined &&
                    window.__UsedOtazky.has(String(q.id))
                )
                    return false;
                return true;
            });

            // deduplikace podle id nebo serializace
            const map = new Map();
            for (const q of filtered) {
                const key =
                    q && q.id !== undefined && q.id !== null
                        ? String(q.id)
                        : JSON.stringify(q);
                if (!map.has(key)) map.set(key, q);
            }
            const unique = Array.from(map.values());

            // promÃ­chat (Fisherâ€“Yates)
            for (let i = unique.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [unique[i], unique[j]] = [unique[j], unique[i]];
            }

            const count = Math.min(28, unique.length);
            const vybrane = unique.slice(0, count);

            // pokud pouÅ¾Ã­vÃ¡me globÃ¡lnÃ­ no-repeat, oznaÄÃ­me vybranÃ© id jako pouÅ¾itÃ©
            if (noRepeatGlobal) {
                for (const q of vybrane) {
                    if (q && q.id !== undefined && q.id !== null)
                        window.__UsedOtazky.add(String(q.id));
                }
            }

            // uloÅ¾it tam, kde to uvidÃ­ vÅ¡echny strÃ¡nky/zÃ¡loÅ¾ky -> localStorage
            const STORAGE_KEY = 'AzKviz.Otazky';
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(vybrane));
                // takÃ© udrÅ¾Ã­me krÃ¡tkÃ½ timestamp (moÅ¾nÃ© vyuÅ¾itÃ­)
                localStorage.setItem(STORAGE_KEY + '.ts', String(Date.now()));
            } catch (err) {
                console.error('Nelze uloÅ¾it do localStorage:', err);
            }
            // pro kompatibilitu v tÃ©to kartÄ› nechÃ¡me window.Otazky takÃ© nastavenÃ©
            window.Otazky = vybrane;

            // notifikace ostatnÃ­m zÃ¡loÅ¾kÃ¡m (BroadcastChannel pokud dostupnÃ½)
            try {
                if (!window.__AzKvizBC) window.__AzKvizBC = new BroadcastChannel('azkviz');
                window.__AzKvizBC.postMessage({ type: 'otazky-updated', ts: Date.now() });
            } catch (err) {
                // BroadcastChannel nenÃ­ podporovÃ¡n -> storage event se i tak vyvolÃ¡ pÅ™i setItem v jinÃ½ch zÃ¡loÅ¾kÃ¡ch
            }

            console.info(
                `StartOtazky: pÅ¯vodnÄ› ${all.length} otÃ¡zek, po filtraci ${unique.length}, vybrÃ¡no ${vybrane.length}.`
            );
            return vybrane;
        }
        // export funkce a automatickÃ© naÄtenÃ­ na DOMContentLoaded
        window.StartOtazky = StartOtazky;

        // helper: naÄÃ­tÃ¡nÃ­ z localStorage (vÃ­cero strÃ¡nek mÅ¯Å¾e pouÅ¾Ã­t)
        window.LoadOtazkyFromStorage = function () {
            try {
                const raw = localStorage.getItem('AzKviz.Otazky');
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (err) {
                console.error('LoadOtazkyFromStorage error', err);
                return null;
            }
        };

        // reagovat na zmÄ›ny z jinÃ½ch zÃ¡loÅ¾ek
        window.addEventListener('storage', (ev) => {
            if (ev.key === 'AzKviz.Otazky' && ev.newValue) {
                try {
                    window.Otazky = JSON.parse(ev.newValue);
                    console.info('window.Otazky aktualizovÃ¡no ze storage eventu');
                } catch (e) { /* ignore */ }
            }
        });
        try {
            if (!window.__AzKvizBC) window.__AzKvizBC = new BroadcastChannel('azkviz');
            window.__AzKvizBC.onmessage = (m) => {
                if (m && m.data && m.data.type === 'otazky-updated') {
                    const loaded = window.LoadOtazkyFromStorage();
                    if (loaded) {
                        window.Otazky = loaded;
                        console.info('window.Otazky aktualizovÃ¡no pÅ™es BroadcastChannel');
                    }
                }
            };
        } catch (e) { /* BroadcastChannel nepodporovÃ¡n */ }

        // automatickÃ© spuÅ¡tÄ›nÃ­ po naÄtenÃ­ DOM (volitelnÃ©)
        window.addEventListener('DOMContentLoaded', () => {
            // pokud uÅ¾ nÄ›kdo uloÅ¾il Otazky do localStorage, naÄteme je
            const existing = window.LoadOtazkyFromStorage();
            if (existing && Array.isArray(existing) && existing.length) {
                window.Otazky = existing;
                console.info('NaÄteno window.Otazky z localStorage pÅ™i startu');
                return;
            }
            // jinak spustÃ­me import z /database.json (opravenÃ¡ cesta na relativnÃ­ soubor)
            StartOtazky('database.json').catch(err => console.error(err));
        });
    </script>
    
    <div class="container" id="container">
        <!-- Å˜ada 1: 1 tlaÄÃ­tko -->
        <div class="row">
            <div class="hex-button" id="btn-1">
                <div class="hexagon">1</div>
            </div>
        </div>

        <!-- Å˜ada 2: 2 tlaÄÃ­tka -->
        <div class="row">
            <div class="hex-button" id="btn-2">
                <div class="hexagon">2</div>
            </div>
            <div class="hex-button" id="btn-3">
                <div class="hexagon">3</div>
            </div>
        </div>

        <!-- Å˜ada 3: 3 tlaÄÃ­tka -->
        <div class="row">
            <div class="hex-button" id="btn-4">
                <div class="hexagon">4</div>
            </div>
            <div class="hex-button" id="btn-5">
                <div class="hexagon">5</div>
            </div>
            <div class="hex-button" id="btn-6">
                <div class="hexagon">6</div>
            </div>
        </div>

        <!-- Å˜ada 4: 4 tlaÄÃ­tka -->
        <div class="row">
            <div class="hex-button" id="btn-7">
                <div class="hexagon">7</div>
            </div>
            <div class="hex-button" id="btn-8">
                <div class="hexagon">8</div>
            </div>
            <div class="hex-button" id="btn-9">
                <div class="hexagon">9</div>
            </div>
            <div class="hex-button" id="btn-10">
                <div class="hexagon">10</div>
            </div>
        </div>

        <!-- Å˜ada 5: 5 tlaÄÃ­tek -->
        <div class="row">
            <div class="hex-button" id="btn-11">
                <div class="hexagon">11</div>
            </div>
            <div class="hex-button" id="btn-12">
                <div class="hexagon">12</div>
            </div>
            <div class="hex-button" id="btn-13">
                <div class="hexagon">13</div>
            </div>
            <div class="hex-button" id="btn-14">
                <div class="hexagon">14</div>
            </div>
            <div class="hex-button" id="btn-15">
                <div class="hexagon">15</div>
            </div>
        </div>

        <!-- Å˜ada 6: 6 tlaÄÃ­tek -->
        <div class="row">
            <div class="hex-button" id="btn-16">
                <div class="hexagon">16</div>
            </div>
            <div class="hex-button" id="btn-17">
                <div class="hexagon">17</div>
            </div>
            <div class="hex-button" id="btn-18">
                <div class="hexagon">18</div>
            </div>
            <div class="hex-button" id="btn-19">
                <div class="hexagon">19</div>
            </div>
            <div class="hex-button" id="btn-20">
                <div class="hexagon">20</div>
            </div>
            <div class="hex-button" id="btn-21">
                <div class="hexagon">21</div>
            </div>
        </div>

        <!-- Å˜ada 7: 7 tlaÄÃ­tek -->
        <div class="row">
            <div class="hex-button" id="btn-22">
                <div class="hexagon">22</div>
            </div>
            <div class="hex-button" id="btn-23">
                <div class="hexagon">23</div>
            </div>
            <div class="hex-button" id="btn-24">
                <div class="hexagon">24</div>
            </div>
            <div class="hex-button" id="btn-25">
                <div class="hexagon">25</div>
            </div>
            <div class="hex-button" id="btn-26">
                <div class="hexagon">26</div>
            </div>
            <div class="hex-button" id="btn-27">
                <div class="hexagon">27</div>
            </div>
            <div class="hex-button" id="btn-28">
                <div class="hexagon">28</div>
            </div>
        </div>
    </div>
    <div id="Otazka"></div>
    <div id="Odpoved"></div>
    <div id="Buttons">
        <button id="OrangeB">Orange</button>
        <button id="BlackB">Black</button>
        <button id="BlueB">Blue</button>
    </div>
</body>

</html>
